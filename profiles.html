<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Manager</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg, error);
            return false;
        };
    </script>

    <link href="bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- NAVIGATION BAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#" onclick="goHome()">Pure Profile Manager</a>
        <div class="ms-auto">
            <button class="btn btn-outline-light btn-sm" onclick="goHome()">üè† Dashboard</button>
        </div>
    </div>
</nav>

<!-- 1. LANDING PAGE FOR LOADING -->
<div id="landingPage" class="container page-section">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card p-4 shadow-sm border-primary">
                <h4 class="text-primary">Initialization Required</h4>
                <p class="text-muted mb-0">Upload <strong>Masterlist Excel</strong> and <strong>Photos Zip</strong> to manage people.</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Files Upload Column -->
        <div class="col-lg-6 offset-lg-3 mb-3">
            <div class="dashboard-card h-100">
                <h5><span class="step-number">1</span>Load Files</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label mt-3 fw-bold">Masterlist Excel</label>
                        <div id="dropExcel" class="drop-zone" title="Browse or Drag File">
                            <div id="excelContent">
                                <div style="font-size: 2rem;">üìÇ</div>
                                <p><strong>Browse</strong> or Drag Excel</p>
                            </div>
                            <input type="file" id="globalExcelInput" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mt-3 fw-bold">Photos Zip</label>
                        <div id="dropZip" class="drop-zone" title="Browse or Drag File">
                            <div id="zipContent">
                                <div style="font-size: 2rem;">ü§ê</div>
                                <p><strong>Browse</strong> or Drag Zip</p>
                            </div>
                            <input type="file" id="globalZipInput" class="hidden" accept=".zip">
                        </div>
                    </div>
                </div>

                <div id="statusArea" class="mt-3 p-3 bg-light border rounded">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Excel Database:</span><span id="statusExcel" class="badge bg-secondary">Pending</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Photo Archive:</span><span id="statusZip" class="badge bg-secondary">Pending</span>
                    </div>
                    <div id="fileStats" class="mt-3 pt-2 border-top text-center text-primary fw-bold hidden">
                        <!-- Stats injected here via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2. PERSON MANAGER -->
<div id="personManagerPage" class="container page-section hidden">
    <div id="personManagerContent">
        
        <!-- SETTINGS TOOLBAR -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card p-2 bg-light border d-flex flex-row justify-content-center align-items-center gap-4">
                    <span class="fw-bold text-muted small text-uppercase">Settings:</span>
                    
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" id="toggleUUIDs" onchange="updateSettings()">
                        <label class="form-check-label small" for="toggleUUIDs">Show UUIDs</label>
                    </div>

                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" id="toggleRestricted" onchange="updateSettings()">
                        <label class="form-check-label small" for="toggleRestricted">Include Restricted Data</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Toggles -->
        <div class="row mb-3">
            <div class="col-12 text-center">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="editorMode" id="modeAdd" autocomplete="off" checked onclick="setEditorMode('add')">
                    <label class="btn btn-outline-primary px-4" for="modeAdd">‚ûï Add New Person</label>
                    <input type="radio" class="btn-check" name="editorMode" id="modeEdit" autocomplete="off" onclick="setEditorMode('edit')">
                    <label class="btn btn-outline-primary px-4" for="modeEdit">‚úèÔ∏è Edit Existing</label>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div id="searchContainerWrapper" class="card p-3 mb-4 shadow-sm hidden">
            <label class="form-label fw-bold">Search Person to Edit</label>
            <div class="search-container">
                <input type="text" id="searchBox" class="form-control form-control-lg" placeholder="Type name or ID..." autocomplete="off">
                <div id="searchResults" class="hidden"></div>
            </div>
        </div>

 <!-- Editor Forms -->
        <div class="row">
            <!-- Details Form -->
            <div class="col-lg-5 mb-3">
                <div class="card p-3 shadow-sm h-100 border-primary" id="personDetailsCard">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h5 class="text-primary m-0" id="formTitle">New Person Details</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetEditor()">Reset</button>
                    </div>
                    
                    <input type="hidden" id="editStagedIndex" value="-1">
                    <input type="hidden" id="editStagedType" value="">

                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small fw-bold">First Name *</label><input type="text" id="p_Firstname" class="form-control"></div>
                        <div class="col-6"><label class="small fw-bold">Last Name *</label><input type="text" id="p_Lastname" class="form-control"></div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small text-muted">Known As (First)</label><input type="text" id="p_KnownFirst" class="form-control"></div>
                        <div class="col-6"><label class="small text-muted">Known As (Last)</label><input type="text" id="p_KnownLast" class="form-control"></div>
                    </div>
                    
                    <label class="small fw-bold text-muted">Person ID</label>
                    <div class="input-group mb-1">
                        <input type="text" id="p_PersonID" class="form-control bg-light" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="regenIdBtn" onclick="generateID()">Generate</button>
                    </div>
                    <small id="idWarning" class="text-danger hidden mb-2 d-block">‚ö†Ô∏è ID already exists!</small>
                    
                    <label class="small fw-bold">Email (Username) *</label><input type="email" id="p_Email" class="form-control mb-2" placeholder="email@university.edu">
                    
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small text-muted">Post Nominals</label><input type="text" id="p_PostNominals" class="form-control"></div>
                        <div class="col-6">                
                            <label class="small text-muted">Visibility</label>
                            <select id="p_Visibility" class="form-select mb-2">
                                <option value="public" selected>public</option>
                                <option value="restricted">restricted</option>
                            </select>
                        </div>
                    </div> 

                    <!-- Photo Card -->
                    <div class="card bg-light p-2 mb-3 border">
                        <div class="d-flex justify-content-between">
                            <label class="small fw-bold">Profile Photo (&lt; 1MB)</label>
                            <small class="text-muted" id="photoStatus">None</small>
                        </div>
                        <div class="text-center my-2 position-relative">
                            <img id="p_PhotoPreview" class="img-thumbnail hidden" style="max-height: 120px;">
                            <div id="photoPlaceholder" class="text-muted small py-4" style="border: 1px dashed #ccc; background: white;">No Photo Selected</div>
                        </div>
                        <input type="file" id="p_PhotoInput" class="form-control form-control-sm" accept=".jpg,.jpeg,.png">
                    </div>

                </div> 
            </div> 

            <!-- Affiliations Grid -->
            <div class="col-lg-7 mb-3">
                <div class="card p-3 shadow-sm h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0 text-primary">Affiliations</h5>
                        <button class="btn btn-sm btn-secondary" onclick="addAffiliationRow()">+ Add Row</button>
                    </div>
                    <div id="affRows" style="min-height: 100px;"></div>
                    <div class="mt-auto pt-3 border-top">
                        <button class="btn btn-primary w-100 btn-lg" id="stageBtn" onclick="stagePersonChange()">Stage Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staging Area -->
        <div id="stagingCard" class="card mt-4 p-4 shadow-sm hidden border-success">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="m-0 text-success">Staged Changes (<span id="totalStageCount">0</span>)</h4>
                <button class="btn btn-success" onclick="downloadAllData()">Download Excel & Zip</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light"><tr><th>Type</th><th>ID</th><th>Name</th><th>Photo</th><th>Changes</th><th class="text-end">Actions</th></tr></thead>
                    <tbody id="stagingBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="bootstrap.bundle.min.js"></script>
<script src="xlsx.full.min.js"></script>
<script src="jszip.min.js"></script>
<script src="FileSaver.min.js"></script>
<script src="globals.js"></script>
<script src="utils.js"></script>
<script src="file-loader.js"></script>
<script src="file-exporter.js"></script>
<script src="form-logic.js"></script>
<script src="main.js"></script>

</body>
</html>